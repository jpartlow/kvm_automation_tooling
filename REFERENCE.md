# Reference

<!-- DO NOT EDIT: This document was generated by Puppet Strings -->

## Table of Contents

### Classes

* [`kvm_automation_tooling`](#kvm_automation_tooling): ATM this is just a placeholder for the module so that rspec-puppet can get_module_name and setup the spec/fixtures/modules link correctly.
* [`kvm_automation_tooling::server::package_prerequisites`](#kvm_automation_tooling--server--package_prerequisites): Ensures package dependencies for openvox-server or openvoxdb.  This class can be used for cases where openvox-server or openvoxdb packages ar

### Functions

* [`kvm_automation_tooling::fill_vm_spec`](#kvm_automation_tooling--fill_vm_spec): Expand a VM specification hash by filling in defaults from a given Hash.
* [`kvm_automation_tooling::generate_terraform_vm_spec_set`](#kvm_automation_tooling--generate_terraform_vm_spec_set): Transforms the array of vm specifications received by the plan into a map of terraform objects (hashes) keyed by a unique "$role.$hostname.$p
* [`kvm_automation_tooling::get_image_url`](#kvm_automation_tooling--get_image_url): Returns the URL of the cloud image for the specified platform.  # NOTES  These are the structure of the URLs for the various platforms as of 
* [`kvm_automation_tooling::get_normalized_os_arch`](#kvm_automation_tooling--get_normalized_os_arch): Return the expected architecture strings for the given os. (amd64, arm64 for debian/ubuntu, and x86_64, aarch64 for others)
* [`kvm_automation_tooling::get_normalized_ubuntu_version`](#kvm_automation_tooling--get_normalized_ubuntu_version): Returns the Ubuntu version number without delimiters.
* [`kvm_automation_tooling::platform`](#kvm_automation_tooling--platform): Generic function to produce a canonical descriptive platform string from a set of os, version and cpu arch values.  Examples:   kvm_automatio
* [`kvm_automation_tooling::resolve_terraform_targets`](#kvm_automation_tooling--resolve_terraform_targets): Manually resolve target references from the given *inventory_file* and return those from the given *group*.
* [`kvm_automation_tooling::transform_openvox_host_version_results`](#kvm_automation_tooling--transform_openvox_host_version_results): Transform the PlanResult ResultSet of package version hashes returned by the kvm_automation_tooling::subplans::install_component plan into a 
* [`kvm_automation_tooling::translate_os_version_codename`](#kvm_automation_tooling--translate_os_version_codename): Translates a Debian or Ubuntu version number to codename, or codename to version number, depending on what it is given.  Raises an error if u
* [`kvm_automation_tooling::validate_openvox_version_parameters`](#kvm_automation_tooling--validate_openvox_version_parameters): Validates the given set of OpenVox install parameters and raises an error for any problems.  If we're installing a released version, then col
* [`kvm_automation_tooling::validate_vm_ip_addresses`](#kvm_automation_tooling--validate_vm_ip_addresses): Check whether ip addresses returned by the terraform apply are all valid ipv4 addresses.  A Bolt::Target.uri needs an ipv4 address when we re

### Data types

* [`Kvm_automation_tooling::Allowed_platforms`](#Kvm_automation_tooling--Allowed_platforms): Enumeration of platforms that the module can pull images for.
* [`Kvm_automation_tooling::Architecture`](#Kvm_automation_tooling--Architecture): Enumeration of possible OS architectures. See docs/ARCHITECTURE.md for more information.
* [`Kvm_automation_tooling::Openvox_collection`](#Kvm_automation_tooling--Openvox_collection): Strings identifying an openvox collection (packages associated with a major version of OpenVox).
* [`Kvm_automation_tooling::Openvox_install_params`](#Kvm_automation_tooling--Openvox_install_params): Parameters defining OpenVox agent version for the kvm_automation_tooling::subplans::install_openvox subplan.  Keys: - openvox_version: The ve
* [`Kvm_automation_tooling::Openvox_version`](#Kvm_automation_tooling--Openvox_version): Matches an OpenVox x.y.z version, a version based off that with some trailing text (such as x.y.z-rc1 or a git describe like x.y.z-123-gabcde
* [`Kvm_automation_tooling::Operating_system`](#Kvm_automation_tooling--Operating_system): Enumeration of base platform operating systems that the plans can use when standing up vms.
* [`Kvm_automation_tooling::Os_arch`](#Kvm_automation_tooling--Os_arch): Enumeration of operating system chip architectures available when standing up vms.
* [`Kvm_automation_tooling::Os_spec`](#Kvm_automation_tooling--Os_spec): Specification for a particular operating system.  Used to determine canonical platform strings and image urls.  Keys: - name: The name of the
* [`Kvm_automation_tooling::Version`](#Kvm_automation_tooling--Version): General type constraint for version strings such as 2404, 24.04, 7, 7.2, 7_0, etc.
* [`Kvm_automation_tooling::Vm_spec`](#Kvm_automation_tooling--Vm_spec): Specification for a set of vms of some count.  Only the base role key is required. The rest of the keys are optional so that a set of common 

### Tasks

* [`add_ssh_authorized_key`](#add_ssh_authorized_key): Adds an SSH public key to the authorized_keys file of a user on a remote host.
* [`create_libvirt_image_pool`](#create_libvirt_image_pool): Idempotently creates a new directory image pool in libvirt. The new pool is created locally within the default storage pool directory.
* [`dev_reset_libvirt_network`](#dev_reset_libvirt_network): Recreates an existing libvirt network with a different address. This script is a hack used by the kvm_automation_tooling::dev::prep_vm_for_mo
* [`download_image`](#download_image): Downloads an image from the given url to a given directory. Requires curl.
* [`generate_keypair`](#generate_keypair): Generate a passphraseless ssh keypair in a temp directory and return the paths to the keypair files.
* [`import_libvirt_volume`](#import_libvirt_volume): Imports a local image file as a libvirt volume in the default pool.

### Plans

* [`kvm_automation_tooling::dev::generate_beaker_hosts_file`](#kvm_automation_tooling--dev--generate_beaker_hosts_file): Convert the puppet inventory group into a hosts.yaml file for use with Beaker.
* [`kvm_automation_tooling::dev::get_cloud_init_logs`](#kvm_automation_tooling--dev--get_cloud_init_logs): Download cloud-init logs from a set of targets for local review.
* [`kvm_automation_tooling::dev::openvox_acceptance`](#kvm_automation_tooling--dev--openvox_acceptance): Dev plan to run an openvox agent, server or db Beaker acceptance test suite from a runner VM against a set of subject test vms.  This plan as
* [`kvm_automation_tooling::dev::prep_vm_for_module_testing`](#kvm_automation_tooling--dev--prep_vm_for_module_testing): This is a dev plan used to test kvm_automation_tooling in a clean environment. It goes one turtle down and nests libvirt within a VM, then se
* [`kvm_automation_tooling::install_openvox`](#kvm_automation_tooling--install_openvox): Install OpenVox Puppet agents and primary services on the cluster without any attempts at configuration.  The openvox_* install parameters ar
* [`kvm_automation_tooling::standup_cluster`](#kvm_automation_tooling--standup_cluster): Standup one cluster of KVM virtual machines based on a given Kvm_automation_tooling::Vm_spec structure.  Makes use of terraform under the hoo
* [`kvm_automation_tooling::subplans::install_component`](#kvm_automation_tooling--subplans--install_component): Installs a single openvox component on behalf of the caller.  Uses puppet-openvox_bootstrap tasks.
* [`kvm_automation_tooling::subplans::install_server_prerequisites`](#kvm_automation_tooling--subplans--install_server_prerequisites): Installs the platform specific set of package dependencies for the openvox-server and openvoxdb packages if the installation parameters indic
* [`kvm_automation_tooling::subplans::lookup_platform`](#kvm_automation_tooling--subplans--lookup_platform): Given a TargetSpec, for each Target that does not yet have a *platform* variable set, obtain platform details and set the *platform* variable
* [`kvm_automation_tooling::subplans::manage_base_image_volume`](#kvm_automation_tooling--subplans--manage_base_image_volume): Ensure that the base image is downloaded for the given platform and imported into libvirt as a volume. Ensure that a libvirt pool for platfor
* [`kvm_automation_tooling::subplans::setup_cluster_ssh`](#kvm_automation_tooling--subplans--setup_cluster_ssh): This plan manages two aspects of ssh access within the cluster.  1. SSH between *controller* and *destination* vms as *user*. 2. SSH between 
* [`kvm_automation_tooling::teardown_cluster`](#kvm_automation_tooling--teardown_cluster): This plan is just a wrapper around the terraform::destroy plan that automatically sets the dir, state and vars_file parameters based on the g

## Classes

### <a name="kvm_automation_tooling"></a>`kvm_automation_tooling`

ATM this is just a placeholder for the module so that rspec-puppet can
get_module_name and setup the spec/fixtures/modules link correctly.

### <a name="kvm_automation_tooling--server--package_prerequisites"></a>`kvm_automation_tooling::server::package_prerequisites`

Ensures package dependencies for openvox-server or openvoxdb.

This class can be used for cases where openvox-server or openvoxdb
packages are downloaded and installed directly, bypassing dependency
handling by package managers like apt or dnf.

## Functions

### <a name="kvm_automation_tooling--fill_vm_spec"></a>`kvm_automation_tooling::fill_vm_spec`

Type: Puppet Language

Expand a VM specification hash by filling in defaults from a given
Hash.

#### `kvm_automation_tooling::fill_vm_spec(Kvm_automation_tooling::Vm_spec $vm_spec, Kvm_automation_tooling::Vm_spec $defaults)`

Expand a VM specification hash by filling in defaults from a given
Hash.

Returns: `Kvm_automation_tooling::Vm_spec` A new VM specification hash with defaults filled in.

##### `vm_spec`

Data type: `Kvm_automation_tooling::Vm_spec`

The VM specification to fill in.

##### `defaults`

Data type: `Kvm_automation_tooling::Vm_spec`

The defaults to override.

### <a name="kvm_automation_tooling--generate_terraform_vm_spec_set"></a>`kvm_automation_tooling::generate_terraform_vm_spec_set`

Type: Puppet Language

Transforms the array of vm specifications received by the plan into
a map of terraform objects (hashes) keyed by a unique
"$role.$hostname.$platform" string with os image parameters injected.

The hostname values are generated as "${cluster_id}-${role}-${index}"
where the index is the 1-based index of the vm in the set.

See the spec/functions/generate_terraform_vm_spec_set_spec.rb for
a concrete example.

Missing values for cpus, mem_mb, disk_gb and cpu_mode are provided
by terraform modules/vm defaults.

#### `kvm_automation_tooling::generate_terraform_vm_spec_set(String $cluster_id, Array[Kvm_automation_tooling::Vm_spec] $vm_specs, Array[Hash] $image_results)`

Transforms the array of vm specifications received by the plan into
a map of terraform objects (hashes) keyed by a unique
"$role.$hostname.$platform" string with os image parameters injected.

The hostname values are generated as "${cluster_id}-${role}-${index}"
where the index is the 1-based index of the vm in the set.

See the spec/functions/generate_terraform_vm_spec_set_spec.rb for
a concrete example.

Missing values for cpus, mem_mb, disk_gb and cpu_mode are provided
by terraform modules/vm defaults.

Returns: `Hash[String, Hash]` A map of terraform objects (hashes) representing vm
parameters for the terraform/modules/vm module, keyed by unique
hostname.

##### `cluster_id`

Data type: `String`

The identifier for the cluster.

##### `vm_specs`

Data type: `Array[Kvm_automation_tooling::Vm_spec]`

The array of vm specifications received by the plan.

##### `image_results`

Data type: `Array[Hash]`

The results of each manage_base_image_volume
plan run for each platform in the specs.

### <a name="kvm_automation_tooling--get_image_url"></a>`kvm_automation_tooling::get_image_url`

Type: Puppet Language

Returns the URL of the cloud image for the specified platform.

# NOTES

These are the structure of the URLs for the various platforms as of
2025-04-30:

## Almalinux

Current (9, 9.5 is latest minor):
Note: these four links all ultimately point to the same image,
I believe, and there aren't other dated (2024mmdd) images
available.
https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-9.5-20241120.x86_64.qcow2
These are the same, just explicitly from the 9.5 subdir...
https://repo.almalinux.org/almalinux/9.5/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
https://repo.almalinux.org/almalinux/9.5/cloud/x86_64/images/AlmaLinux-9-GenericCloud-9.5-20241120.x86_64.qcow2

Historical (note different base vault.almalinux.org...):
https://vault.almalinux.org/9.4/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
https://vault.almalinux.org/9.4/cloud/x86_64/images/AlmaLinux-9-GenericCloud-9.4-20240507.x86_64.qcow2

Almalinux, unlike Debian, appears to only keep the last
historical image of each minor version.

Also, frustratingly, a current 'daily' version like 9.5-20241120
which is the latest almalinux-9 image as of today, does not have
a corresponding link in the vault, unlike a historical
9.4-20240507 image, so I can't make the assumption that any
version of the format x.y-YYYYMMDD is available in the vault...

Pre-release:
Pre-release images are also in vault.alamlinux.org, but it's not
clear to me yet if there are 9.6-beta or 10.0-beta generic cloud
images with cloud-init available for use.

## Rocky

Note: like alma, these four links all ultimately point to the
same image, I believe, and there aren't other dated (2024mmdd)
images available.
https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base-9.5-20241118.0.x86_64.qcow2
https://dl.rockylinux.org/pub/rocky/9.5/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
https://dl.rockylinux.org/pub/rocky/9.5/images/x86_64/Rocky-9-GenericCloud-Base-9.5-20241118.0.x86_64.qcow2

Historical:
Like alma, they are in a separate vault under
dl.rockylinux.org/vault instead of /pub; however, they
apppear to keep additional dated images that are not the 9.y
latest.
https://dl.rockylinux.org/vault/rocky/9.4/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
https://dl.rockylinux.org/vault/rocky/9.4/images/x86_64/Rocky-9-GenericCloud-Base-9.4-20240523.0.x86_64.qcow2
https://dl.rockylinux.org/vault/rocky/9.4/images/x86_64/Rocky-9-GenericCloud-Base-9.4-20240609.0.x86_64.qcow2

Unlike alma, it looks like rocky does keep the latest daily
image in the vault, so 9.5-20241118.0, for example, can also
be found here:

https://dl.rockylinux.org/vault/rocky/9.5/images/x86_64/Rocky-9-GenericCloud-Base-9.5-20241118.0.x86_64.qcow2

Pre-release:
Not sure where these are or if they exist yet. I don't see
anything in their vault for 9.6 or 10.0.

## Debian

https://cloud.debian.org/images/cloud/buster/latest/debian-10-generic-amd64.qcow2
https://cloud.debian.org/images/cloud/buster/20240703-1797/debian-10-generic-amd64-20240703-1797.qcow2
https://cloud.debian.org/images/cloud/buster/daily/20240703-1797/debian-10-generic-amd64-daily-20240703-1797.qcow2
These daily variations are available for released versions,
but are most important for pre-release images
(as of this writing, debian 13 is unreleased...):
https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-generic-amd64-daily.qcow2
https://cloud.debian.org/images/cloud/trixie/daily/20250430-2098/debian-13-generic-amd64-daily-20250430-2098.qcow2

## Ubuntu

https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img
https://cloud-images.ubuntu.com/noble/20250425/noble-server-cloudimg-amd64.img
Don't have a current example beyond the daily builds.
Since openvox/perforce only supply repositories for LTS
versions, the case for what a pre-release image url will look
like is a little academic until 26.04 takes shape.

It's 2025-04-30 as I write this, and Plucky (25.04) is out, and
25.10 is not present on their cloud-images server.
Plucky has the same simple scheme as noble, at any rate.
https://cloud-images.ubuntu.com/plucky/current/plucky-server-cloudimg-amd64.img
https://cloud-images.ubuntu.com/plucky/20250429/plucky-server-cloudimg-amd64.img

# Parameters

#### `kvm_automation_tooling::get_image_url(Kvm_automation_tooling::Os_spec $os_spec)`

Returns the URL of the cloud image for the specified platform.

# NOTES

These are the structure of the URLs for the various platforms as of
2025-04-30:

## Almalinux

Current (9, 9.5 is latest minor):
Note: these four links all ultimately point to the same image,
I believe, and there aren't other dated (2024mmdd) images
available.
https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
https://repo.almalinux.org/almalinux/9/cloud/x86_64/images/AlmaLinux-9-GenericCloud-9.5-20241120.x86_64.qcow2
These are the same, just explicitly from the 9.5 subdir...
https://repo.almalinux.org/almalinux/9.5/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
https://repo.almalinux.org/almalinux/9.5/cloud/x86_64/images/AlmaLinux-9-GenericCloud-9.5-20241120.x86_64.qcow2

Historical (note different base vault.almalinux.org...):
https://vault.almalinux.org/9.4/cloud/x86_64/images/AlmaLinux-9-GenericCloud-latest.x86_64.qcow2
https://vault.almalinux.org/9.4/cloud/x86_64/images/AlmaLinux-9-GenericCloud-9.4-20240507.x86_64.qcow2

Almalinux, unlike Debian, appears to only keep the last
historical image of each minor version.

Also, frustratingly, a current 'daily' version like 9.5-20241120
which is the latest almalinux-9 image as of today, does not have
a corresponding link in the vault, unlike a historical
9.4-20240507 image, so I can't make the assumption that any
version of the format x.y-YYYYMMDD is available in the vault...

Pre-release:
Pre-release images are also in vault.alamlinux.org, but it's not
clear to me yet if there are 9.6-beta or 10.0-beta generic cloud
images with cloud-init available for use.

## Rocky

Note: like alma, these four links all ultimately point to the
same image, I believe, and there aren't other dated (2024mmdd)
images available.
https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
https://dl.rockylinux.org/pub/rocky/9/images/x86_64/Rocky-9-GenericCloud-Base-9.5-20241118.0.x86_64.qcow2
https://dl.rockylinux.org/pub/rocky/9.5/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
https://dl.rockylinux.org/pub/rocky/9.5/images/x86_64/Rocky-9-GenericCloud-Base-9.5-20241118.0.x86_64.qcow2

Historical:
Like alma, they are in a separate vault under
dl.rockylinux.org/vault instead of /pub; however, they
apppear to keep additional dated images that are not the 9.y
latest.
https://dl.rockylinux.org/vault/rocky/9.4/images/x86_64/Rocky-9-GenericCloud-Base.latest.x86_64.qcow2
https://dl.rockylinux.org/vault/rocky/9.4/images/x86_64/Rocky-9-GenericCloud-Base-9.4-20240523.0.x86_64.qcow2
https://dl.rockylinux.org/vault/rocky/9.4/images/x86_64/Rocky-9-GenericCloud-Base-9.4-20240609.0.x86_64.qcow2

Unlike alma, it looks like rocky does keep the latest daily
image in the vault, so 9.5-20241118.0, for example, can also
be found here:

https://dl.rockylinux.org/vault/rocky/9.5/images/x86_64/Rocky-9-GenericCloud-Base-9.5-20241118.0.x86_64.qcow2

Pre-release:
Not sure where these are or if they exist yet. I don't see
anything in their vault for 9.6 or 10.0.

## Debian

https://cloud.debian.org/images/cloud/buster/latest/debian-10-generic-amd64.qcow2
https://cloud.debian.org/images/cloud/buster/20240703-1797/debian-10-generic-amd64-20240703-1797.qcow2
https://cloud.debian.org/images/cloud/buster/daily/20240703-1797/debian-10-generic-amd64-daily-20240703-1797.qcow2
These daily variations are available for released versions,
but are most important for pre-release images
(as of this writing, debian 13 is unreleased...):
https://cloud.debian.org/images/cloud/trixie/daily/latest/debian-13-generic-amd64-daily.qcow2
https://cloud.debian.org/images/cloud/trixie/daily/20250430-2098/debian-13-generic-amd64-daily-20250430-2098.qcow2

## Ubuntu

https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img
https://cloud-images.ubuntu.com/noble/20250425/noble-server-cloudimg-amd64.img
Don't have a current example beyond the daily builds.
Since openvox/perforce only supply repositories for LTS
versions, the case for what a pre-release image url will look
like is a little academic until 26.04 takes shape.

It's 2025-04-30 as I write this, and Plucky (25.04) is out, and
25.10 is not present on their cloud-images server.
Plucky has the same simple scheme as noble, at any rate.
https://cloud-images.ubuntu.com/plucky/current/plucky-server-cloudimg-amd64.img
https://cloud-images.ubuntu.com/plucky/20250429/plucky-server-cloudimg-amd64.img

# Parameters

Returns: `String[1]` The URL of the cloud image for the specified platform.

##### `os_spec`

Data type: `Kvm_automation_tooling::Os_spec`

The platform specification describing the image OS to
download. This will obtain the latest released version of the image.
To get a specific version, ensure that *os_spec.image_version* is
set as well.

To bypass url generation entirely, set
*os_spec.image_url_override* to the complete URL of the desired
image.

### <a name="kvm_automation_tooling--get_normalized_os_arch"></a>`kvm_automation_tooling::get_normalized_os_arch`

Type: Puppet Language

Return the expected architecture strings for the given os. (amd64,
arm64 for debian/ubuntu, and x86_64, aarch64 for others)

#### `kvm_automation_tooling::get_normalized_os_arch(Kvm_automation_tooling::Operating_system $os, Kvm_automation_tooling::Os_arch $arch)`

Return the expected architecture strings for the given os. (amd64,
arm64 for debian/ubuntu, and x86_64, aarch64 for others)

Returns: `Any` The normalized architecture string.

##### `os`

Data type: `Kvm_automation_tooling::Operating_system`

The operating system name (debian, ubuntu, or others).

##### `arch`

Data type: `Kvm_automation_tooling::Os_arch`

The architecture to normalize.

### <a name="kvm_automation_tooling--get_normalized_ubuntu_version"></a>`kvm_automation_tooling::get_normalized_ubuntu_version`

Type: Puppet Language

Returns the Ubuntu version number without delimiters.

#### `kvm_automation_tooling::get_normalized_ubuntu_version(Pattern[/\d{2}[._]?\d{2}/] $version)`

Returns the Ubuntu version number without delimiters.

Returns: `Any` the Ubuntu version number without delimeters.

##### `version`

Data type: `Pattern[/\d{2}[._]?\d{2}/]`

The Ubuntu version number, which may contain
delimiters like '.' or '_'.

### <a name="kvm_automation_tooling--platform"></a>`kvm_automation_tooling::platform`

Type: Puppet Language

Generic function to produce a canonical descriptive platform string
from a set of os, version and cpu arch values.

Examples:
  kvm_automation_tooling::platform({
    'name'    => 'ubuntu',
    'version' => '22.04',
    'arch'    => 'x86_64',
  })
  # => "ubuntu-2204-amd64"

  kvm_automation_tooling::platform({
    'name'    => 'rocky',
    'version' => '8',
    'arch'    => 'x86_64',
  })
  # => "rocky-8-x86_64"

#### `kvm_automation_tooling::platform(Kvm_automation_tooling::Os_spec $os_spec)`

Generic function to produce a canonical descriptive platform string
from a set of os, version and cpu arch values.

Examples:
  kvm_automation_tooling::platform({
    'name'    => 'ubuntu',
    'version' => '22.04',
    'arch'    => 'x86_64',
  })
  # => "ubuntu-2204-amd64"

  kvm_automation_tooling::platform({
    'name'    => 'rocky',
    'version' => '8',
    'arch'    => 'x86_64',
  })
  # => "rocky-8-x86_64"

Returns: `Any` A string in the format "os-version-arch" after munging
version and arch for platform.

##### `os_spec`

Data type: `Kvm_automation_tooling::Os_spec`

A hash containing the operating system name, version,
and architecture.

### <a name="kvm_automation_tooling--resolve_terraform_targets"></a>`kvm_automation_tooling::resolve_terraform_targets`

Type: Puppet Language

Manually resolve target references from the given *inventory_file* and
return those from the given *group*.

#### `kvm_automation_tooling::resolve_terraform_targets(Stdlib::AbsolutePath $inventory_file, String $group_name)`

Manually resolve target references from the given *inventory_file* and
return those from the given *group*.

Returns: `Array<Hash>` An array of target hashes.

##### `inventory_file`

Data type: `Stdlib::AbsolutePath`

Absolute path to a Bolt inventory file
configured with the tfstate files for the cluster we are resolving
targets for.

##### `group_name`

Data type: `String`

The name of the inventory group to pass to the
resolve_references function.

### <a name="kvm_automation_tooling--transform_openvox_host_version_results"></a>`kvm_automation_tooling::transform_openvox_host_version_results`

Type: Puppet Language

Transform the PlanResult ResultSet of package version hashes
returned by the kvm_automation_tooling::subplans::install_component
plan into a Hash of host names to package version hashes.

#### `kvm_automation_tooling::transform_openvox_host_version_results(String $package, PlanResult $results, Hash $initial = {})`

Transform the PlanResult ResultSet of package version hashes
returned by the kvm_automation_tooling::subplans::install_component
plan into a Hash of host names to package version hashes.

Returns: `Hash[String, Hash[String, String]]`

##### `results`

Data type: `PlanResult`

The PlanResult containing the results of the
kvm_automation_tooling::subplans::install_component plan.

##### `initial`

Data type: `Hash`

The initial Hash to reduce the results into.

##### `package`

Data type: `String`



### <a name="kvm_automation_tooling--translate_os_version_codename"></a>`kvm_automation_tooling::translate_os_version_codename`

Type: Puppet Language

Translates a Debian or Ubuntu version number to codename, or
codename to version number, depending on what it is given.

Raises an error if unable to translate the given
version_or_codename.

If given something for an *os* other than debian or ubuntu, it
returns what it was given.

#### `kvm_automation_tooling::translate_os_version_codename(Kvm_automation_tooling::Operating_system $os, Variant[Kvm_automation_tooling::Version,Pattern[/[a-z]+/]] $version_or_codename)`

Translates a Debian or Ubuntu version number to codename, or
codename to version number, depending on what it is given.

Raises an error if unable to translate the given
version_or_codename.

If given something for an *os* other than debian or ubuntu, it
returns what it was given.

Returns: `String[1]` The translated version number or codename.

##### `os`

Data type: `Kvm_automation_tooling::Operating_system`

The operating system name (debian or ubuntu).

##### `version_or_codename`

Data type: `Variant[Kvm_automation_tooling::Version,Pattern[/[a-z]+/]]`

The version number (e.g., 10, 11, 12,
18.04, 20.04), or codename string (trixie, noble, etc.) to
translate.

### <a name="kvm_automation_tooling--validate_openvox_version_parameters"></a>`kvm_automation_tooling::validate_openvox_version_parameters`

Type: Puppet Language

Validates the given set of OpenVox install parameters and raises
an error for any problems.

If we're installing a released version, then collection will be
matched to version. If collection does not exist, an error will be
raised.

If we're installing a pre-release version, then the version
must be explicit, not 'latest', and collection is ignored.

#### `kvm_automation_tooling::validate_openvox_version_parameters(Kvm_automation_tooling::Openvox_install_params $params)`

Validates the given set of OpenVox install parameters and raises
an error for any problems.

If we're installing a released version, then collection will be
matched to version. If collection does not exist, an error will be
raised.

If we're installing a pre-release version, then the version
must be explicit, not 'latest', and collection is ignored.

Returns: `Kvm_automation_tooling::Openvox_install_params` Kvm_automation_tooling::Openvox_install_params with
openvox_collection updated to match version as necessary.

##### `params`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The OpenVox install parameters to validate.

### <a name="kvm_automation_tooling--validate_vm_ip_addresses"></a>`kvm_automation_tooling::validate_vm_ip_addresses`

Type: Puppet Language

Check whether ip addresses returned by the terraform apply
are all valid ipv4 addresses.

A Bolt::Target.uri needs an ipv4 address when we resolve references.

#### `kvm_automation_tooling::validate_vm_ip_addresses(Hash $terraform_apply_result)`

Check whether ip addresses returned by the terraform apply
are all valid ipv4 addresses.

A Bolt::Target.uri needs an ipv4 address when we resolve references.

Returns: `Boolean` Boolean true if all ip addresses are valid ipv4 addresses,
false if any are missing or ipv6.

##### `terraform_apply_result`

Data type: `Hash`

A Hash returned from the
terraform::apply plan (this is the hash from a parsed
`terraform output -json` result).

## Data types

### <a name="Kvm_automation_tooling--Allowed_platforms"></a>`Kvm_automation_tooling::Allowed_platforms`

Enumeration of platforms that the module can pull images for.

Alias of `Enum['almalinux-8-x86_64', 'almalinux-9-x86_64', 'almalinux-10-x86_64', 'debian-10-amd64', 'debian-11-amd64', 'debian-12-amd64', 'debian-13-amd64', 'rocky-8-x86_64', 'rocky-9-x86_64', 'rocky-10-x86_64', 'ubuntu-1804-amd64', 'ubuntu-2004-amd64', 'ubuntu-2204-amd64', 'ubuntu-2404-amd64']`

### <a name="Kvm_automation_tooling--Architecture"></a>`Kvm_automation_tooling::Architecture`

Enumeration of possible OS architectures. See docs/ARCHITECTURE.md for
more information.

Alias of `Enum['singular', 'separated', 'dual']`

### <a name="Kvm_automation_tooling--Openvox_collection"></a>`Kvm_automation_tooling::Openvox_collection`

Strings identifying an openvox collection (packages associated with
a major version of OpenVox).

Alias of `Enum['openvox7', 'openvox8']`

### <a name="Kvm_automation_tooling--Openvox_install_params"></a>`Kvm_automation_tooling::Openvox_install_params`

Parameters defining OpenVox agent version for the
kvm_automation_tooling::subplans::install_openvox
subplan.

Keys:
- openvox_version: The version of OpenVox to install. If installing
  a released version, major version must match openvox_collection,
  or 'latest' to install latest version from collection.
- openvox_collection: The collection of OpenVox to install from.
  ('openvox7', 'openvox8', etc.).
- openvox_released: Whether to install released packages from
  the given openvox_collection via the system package manager,
  or to download and install a pre-release openvox_version package
  from the openvox_artifacts_url for dev testing.
- openvox_artifacts_url: The URL to the OpenVox artifacts server.

Alias of

```puppet
Struct[{
  Optional[openvox_version]       => Kvm_automation_tooling::Openvox_version,
  Optional[openvox_collection]    => Kvm_automation_tooling::Openvox_collection,
  Optional[openvox_released]      => Boolean,
  Optional[openvox_artifacts_url] => Optional[Stdlib::HTTPUrl],
}]
```

### <a name="Kvm_automation_tooling--Openvox_version"></a>`Kvm_automation_tooling::Openvox_version`

Matches an OpenVox x.y.z version, a version based off that with some
trailing text (such as x.y.z-rc1 or a git describe like
x.y.z-123-gabcdef), or the string 'latest'.

Alias of `Variant[Pattern[/^\d+(\.\d+){2}(-.+)?/], Enum['latest']]`

### <a name="Kvm_automation_tooling--Operating_system"></a>`Kvm_automation_tooling::Operating_system`

Enumeration of base platform operating systems that the plans can use
when standing up vms.

Alias of `Enum['almalinux', 'debian', 'rocky', 'ubuntu']`

### <a name="Kvm_automation_tooling--Os_arch"></a>`Kvm_automation_tooling::Os_arch`

Enumeration of operating system chip architectures available when
standing up vms.

Alias of `Enum['x86_64', 'amd64', 'aarch64', 'arm64']`

### <a name="Kvm_automation_tooling--Os_spec"></a>`Kvm_automation_tooling::Os_spec`

Specification for a particular operating system.

Used to determine canonical platform strings and image urls.

Keys:
- name: The name of the operating system (e.g. 'ubuntu', 'debian').
- version: The version of the operating system (e.g. '22.04', '11').
- arch: The architecture of the operating system (e.g. 'x86_64',
  'aarch64').
- image_version: A specific image version to download. (The latest
  released version is downloaded if this is not set.)
  Examples:
    * Debian
      - daily-latest (use this for the latest pre-release version)
      - daily-YYYYMMDD-\d\d\d\d
      - YYYYMMDD-\d\d\d\d
    * Ubuntu
      - YYYYMMDD
- image_url_override: Complete URL pointing to the specific image to
  download. Can be provided to bypass image url construction entirely.

Alias of

```puppet
Struct[{
  name    => Kvm_automation_tooling::Operating_system,
  version => Kvm_automation_tooling::Version,
  arch    => Kvm_automation_tooling::Os_arch,
  Optional[image_version]      => Optional[String[1]],
  Optional[image_url_override] => Optional[Stdlib::HTTPUrl],
}]
```

### <a name="Kvm_automation_tooling--Version"></a>`Kvm_automation_tooling::Version`

General type constraint for version strings such as 2404, 24.04, 7, 7.2, 7_0, etc.

Alias of `Pattern[/^\d+([._]\d+)*$/]`

### <a name="Kvm_automation_tooling--Vm_spec"></a>`Kvm_automation_tooling::Vm_spec`

Specification for a set of vms of some count.

Only the base role key is required. The rest of the keys are optional
so that a set of common parameters can be used with the fill_vm_spec()
function to supply any missing defaults.

Keys:
- role: The role of the vms in set. Will be used as part of the
  hostname along with the cluster-id and the vm count. (Required)
- count: The number of vms in the set.
- os: Details of the operating system image to download and use
  use for the vms. (see [Os_spec](./types/os_spec.pp))
- cpus: The number of CPUs to allocate to each vm.
- mem_mb: The amount of memory in MB to allocate to each vm.
- disk_gb: The amount of disk space in GB to allocate to each vm.
- cpu_mode: The CPU mode to use for the libvirt vm domains. Set this
  to 'host-passthrough' to enable nested virtualization.

Alias of

```puppet
Struct[{
  role => String[1],
  Optional[count]      => Integer[1],
  Optional[os]         => Kvm_automation_tooling::Os_spec,
  Optional[cpus]       => Integer[1],
  Optional[mem_mb]     => Integer[1],
  Optional[disk_gb]    => Integer[1],
  Optional[cpu_mode]   => String[1],
}]
```

## Tasks

### <a name="add_ssh_authorized_key"></a>`add_ssh_authorized_key`

Adds an SSH public key to the authorized_keys file of a user on a remote host.

**Supports noop?** false

#### Parameters

##### `user`

Data type: `String[1]`

The user account.

##### `ssh_public_key`

Data type: `String[1]`

The SSH public key string to add to the authorized_keys file.

### <a name="create_libvirt_image_pool"></a>`create_libvirt_image_pool`

Idempotently creates a new directory image pool in libvirt. The new pool is created locally within the default storage pool directory.

**Supports noop?** false

#### Parameters

##### `name`

Data type: `String[1]`

The name of the pool to create.

##### `path`

Data type: `Optional[String]`

The path to the directory to use for the pool. If relative, it is relative to the default pool path (/var/lib/libvirt/images). If not provided, the path will be the pool name relative to the default pool path.

### <a name="dev_reset_libvirt_network"></a>`dev_reset_libvirt_network`

Recreates an existing libvirt network with a different address. This script is a hack used by the kvm_automation_tooling::dev::prep_vm_for_module_testing plan to manually reset the default virbr0 network in the VM so as not to overlap the host's virbr0 address space.

**Supports noop?** false

#### Parameters

##### `name`

Data type: `String`

The name of the network to reset.

##### `original_network_prefix`

Data type: `String`

The original network prefix of the network to reset.

##### `new_network_prefix`

Data type: `String`

The new network prefix of the network to reset.

### <a name="download_image"></a>`download_image`

Downloads an image from the given url to a given directory. Requires curl.

**Supports noop?** false

#### Parameters

##### `image_url`

Data type: `String`

The URL of the image to download.

##### `download_dir`

Data type: `String`

The directory to download the image to.

### <a name="generate_keypair"></a>`generate_keypair`

Generate a passphraseless ssh keypair in a temp directory and return the paths to the keypair files.

**Supports noop?** false

#### Parameters

##### `type`

Data type: `Enum['ed25519', 'rsa']`

The ssh key type.

##### `bits`

Data type: `Optional[Integer]`

The number of bits in the key.

### <a name="import_libvirt_volume"></a>`import_libvirt_volume`

Imports a local image file as a libvirt volume in the default pool.

**Supports noop?** false

#### Parameters

##### `image_path`

Data type: `String`

Absolute path to the image file to be imported.

##### `volume_name`

Data type: `String`

The volume name to attach to the image in libvirt. It will be created in the default pool.

## Plans

### <a name="kvm_automation_tooling--dev--generate_beaker_hosts_file"></a>`kvm_automation_tooling::dev::generate_beaker_hosts_file`

Convert the puppet inventory group into a hosts.yaml file for
use with Beaker.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::dev::generate_beaker_hosts_file` plan:

* [`hosts`](#-kvm_automation_tooling--dev--generate_beaker_hosts_file--hosts)
* [`hosts_yaml`](#-kvm_automation_tooling--dev--generate_beaker_hosts_file--hosts_yaml)

##### <a name="-kvm_automation_tooling--dev--generate_beaker_hosts_file--hosts"></a>`hosts`

Data type: `TargetSpec`

The hosts to include in the hosts.yaml file.

Default value: `'all'`

##### <a name="-kvm_automation_tooling--dev--generate_beaker_hosts_file--hosts_yaml"></a>`hosts_yaml`

Data type: `String[1]`

An absolute path of the hosts file to generate.

Default value: `'/tmp/hosts.yaml'`

### <a name="kvm_automation_tooling--dev--get_cloud_init_logs"></a>`kvm_automation_tooling::dev::get_cloud_init_logs`

Download cloud-init logs from a set of targets for local review.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::dev::get_cloud_init_logs` plan:

* [`targets`](#-kvm_automation_tooling--dev--get_cloud_init_logs--targets)
* [`local_log_dir`](#-kvm_automation_tooling--dev--get_cloud_init_logs--local_log_dir)

##### <a name="-kvm_automation_tooling--dev--get_cloud_init_logs--targets"></a>`targets`

Data type: `TargetSpec`

The targets to download cloud-init logs from.

##### <a name="-kvm_automation_tooling--dev--get_cloud_init_logs--local_log_dir"></a>`local_log_dir`

Data type: `String`

The local directory to store the logs in.

Default value: `'./tmp'`

### <a name="kvm_automation_tooling--dev--openvox_acceptance"></a>`kvm_automation_tooling::dev::openvox_acceptance`

Dev plan to run an openvox agent, server or db Beaker acceptance
test suite from a runner VM against a set of subject test vms.

This plan assumes that something has already installed the
version of openvox-agent, openvox-server and openvoxdb we want to
test on the agent VMs. It does not use beaker-puppet installation
utilities, since they can't handle packages outside of the default
Perforce package names and repositories.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::dev::openvox_acceptance` plan:

* [`runner`](#-kvm_automation_tooling--dev--openvox_acceptance--runner)
* [`subjects`](#-kvm_automation_tooling--dev--openvox_acceptance--subjects)
* [`project`](#-kvm_automation_tooling--dev--openvox_acceptance--project)
* [`namespace`](#-kvm_automation_tooling--dev--openvox_acceptance--namespace)
* [`branch`](#-kvm_automation_tooling--dev--openvox_acceptance--branch)
* [`user`](#-kvm_automation_tooling--dev--openvox_acceptance--user)
* [`subject_ssh_key`](#-kvm_automation_tooling--dev--openvox_acceptance--subject_ssh_key)
* [`begin_test_execution`](#-kvm_automation_tooling--dev--openvox_acceptance--begin_test_execution)

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--runner"></a>`runner`

Data type: `TargetSpec`

The target spec for the runner VM that will run
the acceptance tests.

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--subjects"></a>`subjects`

Data type: `TargetSpec`

The target spec for the VMs that will be
tested by the acceptance tests.

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--project"></a>`project`

Data type: `Enum[openvox-agent,openvox-server,openvoxdb,puppet]`

The name of the project to test.

Default value: `'openvox-agent'`

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--namespace"></a>`namespace`

Data type: `String`

The Github namespace of the project to test.

Default value: `'OpenVoxProject'`

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--branch"></a>`branch`

Data type: `String`

The branch of the repository to checkout.

Default value: `'main'`

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--user"></a>`user`

Data type: `String`

The user ssh account to access the runner target for
running Beaker.

Default value: `system::env('USER')`

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--subject_ssh_key"></a>`subject_ssh_key`

Data type: `String`

The SSH key Beaker will use to reach
the subject targets. (The default assumes the key generated
by kvm_automation_tooling::standup_cluster::setup_cluster_ssh=true.
Also note that setup_cluster_root_ssh should usually be true
for Beaker to be able to test the subjects correctly.)

Default value: `"/home/${user}/.ssh/id_ed25519"`

##### <a name="-kvm_automation_tooling--dev--openvox_acceptance--begin_test_execution"></a>`begin_test_execution`

Data type: `Boolean`

Whether to start Beaker test execution,
or just prep for it.

Default value: `true`

### <a name="kvm_automation_tooling--dev--prep_vm_for_module_testing"></a>`kvm_automation_tooling::dev::prep_vm_for_module_testing`

This is a dev plan used to test kvm_automation_tooling in a clean
environment. It goes one turtle down and nests libvirt within a VM,
then sets up the ruby and terraform tooling needed to run module plans
and checks out the module code.

It is not intended to bootstrap the module on a workstation, since
you would need the ruby environment already set up to run this plan.
But the steps it takes are what you would need to prep a new
workstation for the module.

NOTE: The plan needs to be run as user that can ssh onto the VM with
sudo privileges.

ATM, intended for Ubuntu. Tested on Ubuntu 24.04:
https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img

NOTE: For nested virtualization to work, the host must have the
kvm_intel or kvm_amd kernel module loaded. This is not done by the plan.
Running `cat /sys/module/kvm_intel/parameters/nested` should return "Y".
In addition, the VM domain must have cpu mode set to host-passthrough.
(If you are using the standup_cluster plan to create a vm to test with,
the mode can be set using the cpu_mode parameter.)

#### Parameters

The following parameters are available in the `kvm_automation_tooling::dev::prep_vm_for_module_testing` plan:

* [`dev_vm`](#-kvm_automation_tooling--dev--prep_vm_for_module_testing--dev_vm)
* [`kvm_module_url`](#-kvm_automation_tooling--dev--prep_vm_for_module_testing--kvm_module_url)
* [`branch`](#-kvm_automation_tooling--dev--prep_vm_for_module_testing--branch)
* [`virbr0_network_prefix`](#-kvm_automation_tooling--dev--prep_vm_for_module_testing--virbr0_network_prefix)
* [`ruby_version`](#-kvm_automation_tooling--dev--prep_vm_for_module_testing--ruby_version)

##### <a name="-kvm_automation_tooling--dev--prep_vm_for_module_testing--dev_vm"></a>`dev_vm`

Data type: `TargetSpec`

The target spec for the VM to be used for testing.

##### <a name="-kvm_automation_tooling--dev--prep_vm_for_module_testing--kvm_module_url"></a>`kvm_module_url`

Data type: `String`

The URL to the kvm_automation_tooling git
repostory. This is used to check out the module code on the VM.

Default value: `'https://github.com/jpartlow/kvm_automation_tooling.git'`

##### <a name="-kvm_automation_tooling--dev--prep_vm_for_module_testing--branch"></a>`branch`

Data type: `String`

The branch to check out.

Default value: `'main'`

##### <a name="-kvm_automation_tooling--dev--prep_vm_for_module_testing--virbr0_network_prefix"></a>`virbr0_network_prefix`

Data type: `String`

The three octet network prefix for the
new virbr0 network on the VM. (Distinguished from the host's virbr0
which will usually be 192.168.122.0/24).

Default value: `'192.168.123'`

##### <a name="-kvm_automation_tooling--dev--prep_vm_for_module_testing--ruby_version"></a>`ruby_version`

Data type: `String`



Default value: `'3.3.0'`

### <a name="kvm_automation_tooling--install_openvox"></a>`kvm_automation_tooling::install_openvox`

Install OpenVox Puppet agents and primary services on the cluster
without any attempts at configuration.

The openvox_* install parameters are passed to tasks in the
openvox_bootstrap module.

Similarly to apply_prep, targets are marked with the puppet-agent
feature, and facts are collected and added to the targets after
agent installation.

NOTE: The agent will be installed on server and db targets as well.

NOTE: The openvoxdb-termini package will be installed on all server
targets by default. Set $install_termini to false to skip this.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::install_openvox` plan:

* [`openvox_agent_targets`](#-kvm_automation_tooling--install_openvox--openvox_agent_targets)
* [`openvox_server_targets`](#-kvm_automation_tooling--install_openvox--openvox_server_targets)
* [`openvox_db_targets`](#-kvm_automation_tooling--install_openvox--openvox_db_targets)
* [`openvox_agent_params`](#-kvm_automation_tooling--install_openvox--openvox_agent_params)
* [`openvox_server_params`](#-kvm_automation_tooling--install_openvox--openvox_server_params)
* [`openvox_db_params`](#-kvm_automation_tooling--install_openvox--openvox_db_params)
* [`install_defaults`](#-kvm_automation_tooling--install_openvox--install_defaults)
* [`install_termini`](#-kvm_automation_tooling--install_openvox--install_termini)
* [`version_file_path`](#-kvm_automation_tooling--install_openvox--version_file_path)

##### <a name="-kvm_automation_tooling--install_openvox--openvox_agent_targets"></a>`openvox_agent_targets`

Data type: `TargetSpec`

The targets to install the OpenVox
Puppet agent on.

##### <a name="-kvm_automation_tooling--install_openvox--openvox_server_targets"></a>`openvox_server_targets`

Data type: `TargetSpec`

The target to install the OpenVox
Puppet server on.

Default value: `[]`

##### <a name="-kvm_automation_tooling--install_openvox--openvox_db_targets"></a>`openvox_db_targets`

Data type: `TargetSpec`

The target to install the OpenVox PuppetDB
on.

Default value: `[]`

##### <a name="-kvm_automation_tooling--install_openvox--openvox_agent_params"></a>`openvox_agent_params`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The set of
Kvm_automation_tooling::Openvox_install_params defining source
and version for the openvox-agent package to install on all
$targets.

Default value: `{}`

##### <a name="-kvm_automation_tooling--install_openvox--openvox_server_params"></a>`openvox_server_params`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The install params for the
openvox-server package to install on the $openvox_server_targets.

Default value: `{}`

##### <a name="-kvm_automation_tooling--install_openvox--openvox_db_params"></a>`openvox_db_params`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The install params for the
openvoxdb package to install on the $openvox_db_targets.

Default value: `{}`

##### <a name="-kvm_automation_tooling--install_openvox--install_defaults"></a>`install_defaults`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The default parameters to include
in each of the $openvox_*_params hashes.

Default value:

```puppet
{
      'openvox_version'       => 'latest',
      'openvox_collection'    => 'openvox8',
      'openvox_released'      => true,
    }
```

##### <a name="-kvm_automation_tooling--install_openvox--install_termini"></a>`install_termini`

Data type: `Boolean`

Whether to install the openvoxdb-termini
package on the $openvox_server_targets. The openvoxdb-termini
package contains Puppet terminus classes, functions and faces for
interacting with openvoxdb and is typically used to configure
openvox-server for communicating with openvoxdb.

Default value: `true`

##### <a name="-kvm_automation_tooling--install_openvox--version_file_path"></a>`version_file_path`

Data type: `Optional[String[1]]`

Optional path to write an
openox_versions.<cluster_id>.json file containing the version map
of all installed OpenVox components. Useful for debugging in
automated pipelines. If undef (default), the file will not
be written.

Default value: `undef`

### <a name="kvm_automation_tooling--standup_cluster"></a>`kvm_automation_tooling::standup_cluster`

Standup one cluster of KVM virtual machines based on a given
Kvm_automation_tooling::Vm_spec structure.

Makes use of terraform under the hood for vm initialization.

  The os, os_version and os_arch keys are provided by the top
  level plan parameters unless overridden in a specific spec hash.
  The count key is optional and defaults to 1.
  (See the Kvm_automation_tooling::Vm_spec type for details.)

#### Parameters

The following parameters are available in the `kvm_automation_tooling::standup_cluster` plan:

* [`cluster_id`](#-kvm_automation_tooling--standup_cluster--cluster_id)
* [`os`](#-kvm_automation_tooling--standup_cluster--os)
* [`os_version`](#-kvm_automation_tooling--standup_cluster--os_version)
* [`os_arch`](#-kvm_automation_tooling--standup_cluster--os_arch)
* [`image_version`](#-kvm_automation_tooling--standup_cluster--image_version)
* [`image_url_override`](#-kvm_automation_tooling--standup_cluster--image_url_override)
* [`vms`](#-kvm_automation_tooling--standup_cluster--vms)
* [`network_addresses`](#-kvm_automation_tooling--standup_cluster--network_addresses)
* [`domain_name`](#-kvm_automation_tooling--standup_cluster--domain_name)
* [`architecture`](#-kvm_automation_tooling--standup_cluster--architecture)
* [`image_download_dir`](#-kvm_automation_tooling--standup_cluster--image_download_dir)
* [`terraform_state_dir`](#-kvm_automation_tooling--standup_cluster--terraform_state_dir)
* [`user`](#-kvm_automation_tooling--standup_cluster--user)
* [`ssh_public_key_path`](#-kvm_automation_tooling--standup_cluster--ssh_public_key_path)
* [`ssh_private_key_path`](#-kvm_automation_tooling--standup_cluster--ssh_private_key_path)
* [`setup_cluster_ssh`](#-kvm_automation_tooling--standup_cluster--setup_cluster_ssh)
* [`setup_cluster_root_ssh`](#-kvm_automation_tooling--standup_cluster--setup_cluster_root_ssh)
* [`host_root_access`](#-kvm_automation_tooling--standup_cluster--host_root_access)
* [`user_password`](#-kvm_automation_tooling--standup_cluster--user_password)
* [`install_openvox`](#-kvm_automation_tooling--standup_cluster--install_openvox)
* [`install_openvox_params`](#-kvm_automation_tooling--standup_cluster--install_openvox_params)

##### <a name="-kvm_automation_tooling--standup_cluster--cluster_id"></a>`cluster_id`

Data type: `Pattern['[[a-z][A-Z][0-9]-]+']`

This should be a short, unique string per cluster.
It must obey the character constraints for hostname as it is
combined with the vm spec role and count to form unique hostnames
for each vm in the cluster..

##### <a name="-kvm_automation_tooling--standup_cluster--os"></a>`os`

Data type: `Optional[Kvm_automation_tooling::Operating_system]`

The default operating system of the cluster.
NOTE: os, os_version and os_arch are only 'optional' in the sense
that they can be specified specifically in the vm spec hashes. But
if not provided, each vm spec hash must have them set.
Additionally, if one is set, all three must be set to define the
platform.

Default value: `undef`

##### <a name="-kvm_automation_tooling--standup_cluster--os_version"></a>`os_version`

Data type: `Optional[Kvm_automation_tooling::Version]`

The version of the default operating system of the
cluster.

Default value: `undef`

##### <a name="-kvm_automation_tooling--standup_cluster--os_arch"></a>`os_arch`

Data type: `Optional[Kvm_automation_tooling::Os_arch]`

The chip architecture of the default operating system
of the cluster.

Default value: `undef`

##### <a name="-kvm_automation_tooling--standup_cluster--image_version"></a>`image_version`

Data type: `Optional[String[1]]`

Specific image version to download. If not set,
the latest released version is downloaded. (See
[Kvm_automation_tooling::Os_spec](./types/os_spec.pp) for
details.)

Default value: `undef`

##### <a name="-kvm_automation_tooling--standup_cluster--image_url_override"></a>`image_url_override`

Data type: `Optional[Stdlib::HTTPUrl]`

Complete URL pointing to the specific
image to download. (See
[Kvm_automation_tooling::Os_spec](./types/os_spec.pp) for
details.)

Default value: `undef`

##### <a name="-kvm_automation_tooling--standup_cluster--vms"></a>`vms`

Data type: `Array[Kvm_automation_tooling::Vm_spec,1]`

An array of VM specifications for the cluster. Example:
[
  {
    'role' => 'primary',
    'cpus' => 8,
    'mem_mb'  => 8192,
    'disk_gb' => 20,
  },
  {
    'role'  => 'agent',
    'count' => 3,
  },
]

##### <a name="-kvm_automation_tooling--standup_cluster--network_addresses"></a>`network_addresses`

Data type: `Stdlib::Ip::Address::V4::CIDR`

The network address range to use for the
cluster. This should be a /24 CIDR block.

##### <a name="-kvm_automation_tooling--standup_cluster--domain_name"></a>`domain_name`

Data type: `String`

The domain name to use for the cluster. This is
appended to the hostnames of the VMs in the cluster, and will
resolve locally within the cluster.

Default value: `'vm'`

##### <a name="-kvm_automation_tooling--standup_cluster--architecture"></a>`architecture`

Data type: `Kvm_automation_tooling::Architecture`

The Puppet services architecture of the cluster
(see docs/ARCHITECTURE.md). (Currently unused.)

Default value: `'singular'`

##### <a name="-kvm_automation_tooling--standup_cluster--image_download_dir"></a>`image_download_dir`

Data type: `String`

The directory where base os images are
downloaded to. This should be an absolute path.

Default value: `"${system::env('HOME')}/images"`

##### <a name="-kvm_automation_tooling--standup_cluster--terraform_state_dir"></a>`terraform_state_dir`

Data type: `String`

The directory where terraform state files,
and the Bolt inventory files for the cluster instances, are stored.
This should be an absolute or Puppet module relative path that the
find_files function can locate.

Default value: `'kvm_automation_tooling/../terraform/instances'`

##### <a name="-kvm_automation_tooling--standup_cluster--user"></a>`user`

Data type: `String`

The login user to create on the vms for ssh access.
Defaults to the *USER* env variable. If set to something else, this
must match up with either your local ssh config, or an override in
the Bolt inventory file.

Default value: `system::env('USER')`

##### <a name="-kvm_automation_tooling--standup_cluster--ssh_public_key_path"></a>`ssh_public_key_path`

Data type: `String`

The path to the public key to add to the
guest's login user ~/.ssh/authorized_keys, allowing ssh access.

Default value: `"${system::env('HOME')}/.ssh/id_rsa.pub"`

##### <a name="-kvm_automation_tooling--standup_cluster--ssh_private_key_path"></a>`ssh_private_key_path`

Data type: `String`

The path to the private key to use for
ssh access to the vms. (This will be set in the generated inventory
file.)

Default value: `regsubst($ssh_public_key_path, '(.*).pub', '\\1')`

##### <a name="-kvm_automation_tooling--standup_cluster--setup_cluster_ssh"></a>`setup_cluster_ssh`

Data type: `Boolean`

Whether to setup ssh access between
the VMs in the cluster. This is done by creating a new ssh keypair
on controller VMs (any vm with the role of 'primary' or 'runner'),
and adding the public key to the login account of all other vms in
the cluster.
See the kvm_automation_tooling::subplans::setup_cluster_ssh
plan for details.

Default value: `true`

##### <a name="-kvm_automation_tooling--standup_cluster--setup_cluster_root_ssh"></a>`setup_cluster_root_ssh`

Data type: `Boolean`

Whether to allow root ssh
access between controller and destination VMs in the cluster. Only
applies if *setup_cluster_ssh* is true.

Default value: `false`

##### <a name="-kvm_automation_tooling--standup_cluster--host_root_access"></a>`host_root_access`

Data type: `Boolean`

Whether to allow root ssh access from the
host machine to all VMs in the cluster. The *ssh_public_key_path*
key is propogated to all *user* accounts on the generated VMs
automatically as part of cloud-init during the Terraform. Without
this, Bolt wouldn't be able to communicate with the VMs as *user*.
This flag determines whether to additionally add this public key
to the root accounts.

Default value: `false`

##### <a name="-kvm_automation_tooling--standup_cluster--user_password"></a>`user_password`

Data type: `Optional[String]`

The password to set for the login user on the
vms. This is optional and should only be used for debugging.

Default value: `undef`

##### <a name="-kvm_automation_tooling--standup_cluster--install_openvox"></a>`install_openvox`

Data type: `Boolean`

Whether to install openvox Puppet(TM) on the
vms in the cluster.

Default value: `true`

##### <a name="-kvm_automation_tooling--standup_cluster--install_openvox_params"></a>`install_openvox_params`

Data type:

```puppet
Struct[{
    Optional[openvox_agent_params]  => Kvm_automation_tooling::Openvox_install_params,
    Optional[openvox_server_params] => Kvm_automation_tooling::Openvox_install_params,
    Optional[openvox_db_params]     => Kvm_automation_tooling::Openvox_install_params,
    Optional[install_defaults]      => Kvm_automation_tooling::Openvox_install_params,
  }]
```

A hash of parameters to pass to the
kvm_automation_tooling::install_openvox plan if
installing something other than the latest agent package from
the latest collection.

Default value: `{}`

### <a name="kvm_automation_tooling--subplans--install_component"></a>`kvm_automation_tooling::subplans::install_component`

Installs a single openvox component on behalf of the caller.

Uses puppet-openvox_bootstrap tasks.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::subplans::install_component` plan:

* [`targets`](#-kvm_automation_tooling--subplans--install_component--targets)
* [`package`](#-kvm_automation_tooling--subplans--install_component--package)
* [`params`](#-kvm_automation_tooling--subplans--install_component--params)
* [`defaults`](#-kvm_automation_tooling--subplans--install_component--defaults)

##### <a name="-kvm_automation_tooling--subplans--install_component--targets"></a>`targets`

Data type: `TargetSpec`

The targets to install the component on.

##### <a name="-kvm_automation_tooling--subplans--install_component--package"></a>`package`

Data type: `String`

The name of the package to install.

##### <a name="-kvm_automation_tooling--subplans--install_component--params"></a>`params`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The parameters for the openvox installation.

##### <a name="-kvm_automation_tooling--subplans--install_component--defaults"></a>`defaults`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The default parameters for the openvox installation.

### <a name="kvm_automation_tooling--subplans--install_server_prerequisites"></a>`kvm_automation_tooling::subplans::install_server_prerequisites`

Installs the platform specific set of package dependencies for
the openvox-server and openvoxdb packages if the installation
parameters indicate we are install a pre-release package from
artifacts.

The pre-release packages are downloaded directly from the artifacts
server and installed with rpm or dpkg, so no package dependencies
are automatically installed by a higher layer like apt or dnf, which
is why we need this subplan.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::subplans::install_server_prerequisites` plan:

* [`targets`](#-kvm_automation_tooling--subplans--install_server_prerequisites--targets)
* [`package`](#-kvm_automation_tooling--subplans--install_server_prerequisites--package)
* [`params`](#-kvm_automation_tooling--subplans--install_server_prerequisites--params)
* [`defaults`](#-kvm_automation_tooling--subplans--install_server_prerequisites--defaults)

##### <a name="-kvm_automation_tooling--subplans--install_server_prerequisites--targets"></a>`targets`

Data type: `TargetSpec`

The targets to install the packages on.

##### <a name="-kvm_automation_tooling--subplans--install_server_prerequisites--package"></a>`package`

Data type: `String`

The name of the package to install. The subplan
will do nothing if the package does not match one needing
pre-requisite packages.

##### <a name="-kvm_automation_tooling--subplans--install_server_prerequisites--params"></a>`params`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The parameters for the openvox installation.
If evaluation of params and defaults does not indicate that
the package is a pre-release package, then this plan will
do nothing.

##### <a name="-kvm_automation_tooling--subplans--install_server_prerequisites--defaults"></a>`defaults`

Data type: `Kvm_automation_tooling::Openvox_install_params`

The default parameters for the openvox installation.

### <a name="kvm_automation_tooling--subplans--lookup_platform"></a>`kvm_automation_tooling::subplans::lookup_platform`

Given a TargetSpec, for each Target that does not yet have a
*platform* variable set, obtain platform details and set the
*platform* variable.

This plan takes advantage of the fact that Target state is
preserved in the inventory in memory, so a calling plan will see the
*platform* variables so long as it is working with actual Target
objects.

NOTE: If an inventory.<cluster_id>.yaml file has been given to Bolt,
the targets should already have *platform* set from the domain
metadata values.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::subplans::lookup_platform` plan:

* [`targets`](#-kvm_automation_tooling--subplans--lookup_platform--targets)

##### <a name="-kvm_automation_tooling--subplans--lookup_platform--targets"></a>`targets`

Data type: `TargetSpec`

The targets to lookup platform details for.

### <a name="kvm_automation_tooling--subplans--manage_base_image_volume"></a>`kvm_automation_tooling::subplans::manage_base_image_volume`

Ensure that the base image is downloaded for the given platform and
imported into libvirt as a volume. Ensure that a libvirt pool for
platform images based on this volume is created as well.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::subplans::manage_base_image_volume` plan:

* [`os_spec`](#-kvm_automation_tooling--subplans--manage_base_image_volume--os_spec)
* [`image_download_dir`](#-kvm_automation_tooling--subplans--manage_base_image_volume--image_download_dir)

##### <a name="-kvm_automation_tooling--subplans--manage_base_image_volume--os_spec"></a>`os_spec`

Data type: `Kvm_automation_tooling::Os_spec`

The operating system specification for the base
image.

##### <a name="-kvm_automation_tooling--subplans--manage_base_image_volume--image_download_dir"></a>`image_download_dir`

Data type: `String`

The directory where the base image will be
downloaded and stored.

### <a name="kvm_automation_tooling--subplans--setup_cluster_ssh"></a>`kvm_automation_tooling::subplans::setup_cluster_ssh`

This plan manages two aspects of ssh access within the cluster.

1. SSH between *controller* and *destination* vms as *user*.
2. SSH between *controller* and *destination* vms as *root*.

The plan generates a single passphraseless ssh keypair, distributes
it as the default keypair for the given user on all controller VMs,
and adds the public key to the authorized_keys file of the user on
each destination VM. If root_access is true, the public key is also
added to the authorized_keys file of the root user on each
destination VM.

This is intended for use on development clusters where the vms
need a simple way to interact with each other via ssh. (Typically
a particular runner node will execute acceptance tests across the
cluster via ssh, either as the *user* or as root.)

There is nothing secure about this plan :) It is purely a testing
convenience.

If controllers is an empty set, nothing is done.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::subplans::setup_cluster_ssh` plan:

* [`controllers`](#-kvm_automation_tooling--subplans--setup_cluster_ssh--controllers)
* [`destinations`](#-kvm_automation_tooling--subplans--setup_cluster_ssh--destinations)
* [`user`](#-kvm_automation_tooling--subplans--setup_cluster_ssh--user)
* [`key_type`](#-kvm_automation_tooling--subplans--setup_cluster_ssh--key_type)
* [`root_access`](#-kvm_automation_tooling--subplans--setup_cluster_ssh--root_access)

##### <a name="-kvm_automation_tooling--subplans--setup_cluster_ssh--controllers"></a>`controllers`

Data type: `TargetSpec`

The target spec for the controller VMs that will
receie the generated ssh keypair.

##### <a name="-kvm_automation_tooling--subplans--setup_cluster_ssh--destinations"></a>`destinations`

Data type: `TargetSpec`

The target spec for the VMs that controllers
are athorized to log into.

##### <a name="-kvm_automation_tooling--subplans--setup_cluster_ssh--user"></a>`user`

Data type: `String[1]`

The user ssh account on the vms.

##### <a name="-kvm_automation_tooling--subplans--setup_cluster_ssh--key_type"></a>`key_type`

Data type: `String[1]`

The type of ssh key to generate. (ed25519 or rsa)

Default value: `'ed25519'`

##### <a name="-kvm_automation_tooling--subplans--setup_cluster_ssh--root_access"></a>`root_access`

Data type: `Boolean`

Whether to allow root access to the destination
VMs. (Required for Beaker, for example.)

Default value: `true`

### <a name="kvm_automation_tooling--teardown_cluster"></a>`kvm_automation_tooling::teardown_cluster`

This plan is just a wrapper around the terraform::destroy plan
that automatically sets the dir, state and vars_file parameters based
on the given cluster_id.

It also cleans up state in the terraform/instances directory and
removes the local cluster specific inventory file.

#### Parameters

The following parameters are available in the `kvm_automation_tooling::teardown_cluster` plan:

* [`cluster_id`](#-kvm_automation_tooling--teardown_cluster--cluster_id)
* [`terraform_state_dir`](#-kvm_automation_tooling--teardown_cluster--terraform_state_dir)

##### <a name="-kvm_automation_tooling--teardown_cluster--cluster_id"></a>`cluster_id`

Data type: `String`

The unique identifier for the cluster to destroy.

##### <a name="-kvm_automation_tooling--teardown_cluster--terraform_state_dir"></a>`terraform_state_dir`

Data type: `String`

The directory where terraform state files
are stored. This should be an absolute or Puppet module relative
path that the find_files function can locate.

Default value: `'kvm_automation_tooling/../terraform/instances'`

